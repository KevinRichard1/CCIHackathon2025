<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grant Application Viewer</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .app-card {
      background: #fff;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      word-break: break-word;
    }
    #orgSelect {
      margin-bottom: 1rem;
      font-size: 1rem;
      padding: 0.3rem 0.6rem;
    }
    .accordion-toggle {
      cursor: pointer;
      width: 100%;
      text-align: left;
      padding: 0.5rem;
      background-color: #eee;
      border: none;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-content {
      display: none;
      padding: 0.5rem 1rem;
      border-left: 3px solid var(--primary-color, #333);
      background-color: #f9f9f9;
      white-space: pre-wrap;
      margin-bottom: 1rem;
    }
    .accordion-content.open {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Submitted Grant Applications</h1>

    <label for="orgSelect"><strong>Select Organization:</strong></label><br/>
    <select id="orgSelect"></select>

    <div id="org-info" style="margin-bottom:1rem;"></div>
    <div id="applicationsContainer"></div>
  </div>

  <script>
    let orgs = [];
    let applications = [];
    let currentOrgId = null;

    async function loadOrgs() {
      const res = await fetch("orgs.json");
      orgs = await res.json();
    }

    function renderOrgHeader(org) {
      const container = document.getElementById("org-info");

      const initials = org.name
        .split(" ")
        .map(word => word[0])
        .join("")
        .toUpperCase()
        .slice(0, 3);

      const logoHtml = org.logo
        ? `<img src="${org.logo}" alt="${org.name} logo" class="org-logo" style="width:60px; height:60px; object-fit: contain; margin-right:1rem; border-radius: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
        : '';

      const placeholderLogo = `
        <div class="logo-placeholder" style="
          width: 60px; height: 60px;
          background-color: ${org.color};
          border-radius: 50%;
          color: white;
          display: ${org.logo ? "none" : "flex"};
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 24px;
          margin-right: 1rem;
          user-select:none;
        ">
          ${initials}
        </div>
      `;

      container.innerHTML = `
        <div class="org-banner" style="background-color:${org.color}; color:#fff; padding:1rem; border-radius:6px; display:flex; align-items:center;">
          ${logoHtml}${placeholderLogo}
          <div>
            <h2>${org.name}</h2>
            <p>${org.description}</p>
          </div>
        </div>
      `;

      document.body.style.setProperty('--primary-color', org.color);
    }

    function renderApplications(apps) {
      const container = document.getElementById("applicationsContainer");
      container.innerHTML = "";

      if (apps.length === 0) {
        container.innerHTML = "<p>No applications found for this organization.</p>";
        return;
      }

      apps.forEach(app => {
        const wrapper = document.createElement("div");
        wrapper.className = "application-entry";

        const summary = document.createElement("button");
        summary.className = "accordion-toggle";
        summary.innerHTML = `
          <span><strong>${app.applicantName || "Unnamed Applicant"}</strong> — ${app.title || "Untitled Project"}</span>
          <span>▼</span>
        `;

        const content = document.createElement("div");
        content.className = "accordion-content";

        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(app, null, 2);
        content.appendChild(pre);

        summary.addEventListener("click", () => {
          content.classList.toggle("open");
          summary.querySelector("span:last-child").textContent = content.classList.contains("open") ? "▲" : "▼";
        });

        wrapper.appendChild(summary);
        wrapper.appendChild(content);
        container.appendChild(wrapper);
      });
    }

    function loadApplicationsForOrg(orgId) {
      applications = JSON.parse(localStorage.getItem("applications") || "[]");
      return applications.filter(app => app.orgId === orgId);
    }

    function populateOrgSelector() {
      const select = document.getElementById("orgSelect");
      select.innerHTML = "";

      orgs.forEach(org => {
        const option = document.createElement("option");
        option.value = org.id;
        option.textContent = org.name;
        select.appendChild(option);
      });

      // Set initial value & event listener
      select.value = currentOrgId;
      select.addEventListener("change", (e) => {
        currentOrgId = e.target.value;
        updateViewForOrg(currentOrgId);
      });
    }

    function updateViewForOrg(orgId) {
      const org = orgs.find(o => o.id === orgId);
      if (!org) return;

      renderOrgHeader(org);
      const filteredApps = loadApplicationsForOrg(orgId);
      renderApplications(filteredApps);
    }

    async function init() {
      await loadOrgs();
      currentOrgId = orgs.length ? orgs[0].id : null;

      populateOrgSelector();

      if (currentOrgId) {
        updateViewForOrg(currentOrgId);
      }
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>